# ТЗ: Web-приложение для планирования

## 1. Область и цели

* ведение **ресурсных строк** с мощностью по неделям;
* планирование **задач** по неделям под ограничения мощности и **зависимости** (*Blocker*);
* авто-вычисления **Start/End/Fact** и меток **Sprints (auto)**;
* редактирование недель «как в таблице»: клик, дабл-клик, «мазок» мышью;
* **фильтры** по всем атрибутам (кроме недель);
* **упорядочивание** строк drag-and-drop (ресурсы отдельно от задач);
* задание **цветов** для Fn и Empl (раскраска задач);
* справочник **«Спринты»**.

> Важно: у задач **нет** статуса «Ресурс». Ресурсы — отдельный тип строки.

---

## 2. Сущности и поля

### 2.1. Спринт

| Поле    | Тип    | Правила                        |
| ------- | ------ | ------------------------------ |
| `code`  | string | Код спринта, например `Q3S1`.  |
| `start` | date   | Дата начала (включительно).    |
| `end`   | date   | Дата окончания (включительно). |

Используется: подписи недель и вычисление **Sprints (auto)**.

---

### 2.2. Ресурсная строка (`kind = "resource"`)

| Поле           | Тип            | Правила                                                     |
| -------------- | -------------- | ----------------------------------------------------------- |
| `team`         | string         | Обяз.                                                       |
| `fn`           | string         | Обяз.                                                       |
| `empl`         | string \| null | Опц. Если задан, ресурс относится к конкретному сотруднику. |
| `weeks[#1…#N]` | number ≥ 0     | Доступная мощность по неделям.                              |

**Цвета**:

* Можно задать цвет для `fn` и/или для конкретного `empl` (override).
* При раскраске задач: `color(task) = color(empl) ?? color(fn) ?? default`.

---

### 2.3. Задача (`kind = "task"`)

| Поле              | Тип                    | Правила                                                                               |
| ----------------- | ---------------------- |---------------------------------------------------------------------------------------|
| `status`          | enum                   | `Todo \| Backlog \| Cancelled`.                                                       |
| `sprintsAuto`     | string (readonly)      | Список кодов спринтов через запятую для фактического интервала `[startWeek…endWeek]`. |
| `epic`            | string                 | Название эпика к которой относится задача                                             |
| `task`            | string                 | Название задачи.                                                                      |
| `team`            | string                 | Выпадающий список из всех доступных команд                                            |
| `fn`              | string                 | Выпадающий список из всех доступных функций                                           |
| `empl`            | string \| null         | Опц. Если задан — задача потребляет мощность **только** ресурсов `team+fn+empl`.      |
| `planEmpl`        | number ≥ 0             | Одновременная потребность в каждую активную неделю.                                   |
| `planWeeks`       | integer ≥ 0            | Длительность (непрерывные недели).                                                    |
| `blockerIds`      | Task\[]                | Список зависимостей (см. §5). Колонка **readonly** (чипы + ✖ удалить).                |
| `fact`            | number (readonly)      | Сумма недельных значений.                                                             |
| `startWeek`       | int \| null (readonly) | Первая неделя с > 0.                                                                  |
| `endWeek`         | int \| null (readonly) | Последняя неделя с > 0.                                                               |
| `autoPlanEnabled` | boolean                | Чекбокс «Auto».                                                                       |
| `manualEdited`    | boolean                | Признак ручных правок недель.                                                         |
| `weeks[#1…#N]`    | number ≥ 0             | Фактическая раскладка по неделям.                                                     |

---

## 3. Экран «План»

### 3.1. Сетка и заголовки недель

* Левая часть: атрибутные колонки. Правая часть: горизонтальный таймлайн из недель `#1…#N`.
* Заголовок каждой недельной колонки показывает:

   * `#<номер>` (1-базовый),
   * код спринта, выводим тут тот спринт у которого большее по дням пересечение с днями текущей недели, 
   * подпись `[ DD.MM` - дата начала спринта, показываем для той недели в которой есть дата начала спринта (который мы определили по логике выше)
   * подпись `DD.MM ]` - дата окончания спринта, показываем для той недели в которой есть дата окончания спринта который мы определили по логике выше

**Генерация недельной шкалы**:

* Непрерывная шкала с шагом 7 дней от `week1.start = sprints[0].start`.
* Для недели `w (0-баз.)`:

   * `weekStart = week1.start + w*7 дней`,
   * `sprintCode = first(s in sprints: weekStart ∈ [s.start .. s.end])`.

---

### 3.2. Колонки слева направо

1. **Тип** (readonly, «Ресурс»/«Задача»).
2. **Status** (только задачи; селект).
3. **Sprints (auto)** (readonly, строки кодов).
4. **Epic** (текст).
5. **Task** (текст).
6. **Team** (текст).
7. **Fn** (текст; у **ресурса** — контекстное меню «выбрать цвет»).
8. **Empl** (текст; у **ресурса** — контекстное меню «выбрать цвет»).
9. **Plan empl** (number; задача).
10. **Plan weeks** (number; задача).
11. **Blocker** (readonly): чипы `Task` с ✖ (удалить зависимость).
12. **Fact** (readonly).
13. **Start** (readonly).
14. **End** (readonly).
15. **Auto** (checkbox; задача).
    16+) **Недели #1…#N**:

* **ресурс** — ввод числа мощности;
* **задача** — ввод фактической загрузки.

---

### 3.3. Навигация, выделение и редактирование

**Выделение**:

* Одиночный клик — выделяет ячейку (фон **светло-серый**).
* Видимое состояние выделения — обязательно для **любой** ячейки, включая недельные.

**Стрелки**:

* `←/→` перемещают выделение на соседние **колонки** (сквозной порядок: от «Тип» до последней недели).

**Редактирование**:

* `Enter` или **двойной клик** по **редактируемой** ячейке — включает инлайн-редактор.
* В режиме редактирования:

   * `Enter` — **сохранить** и выйти;
   * `Esc` — **отменить** изменения и выйти;
   * `Blur` — сохранить, если не было `Esc`.

**Space**:

* Если выделена ячейка **Auto** — переключает чекбокс (см. §3.9, подтверждение при ручном плане).

---

### 3.4. Перетаскивание строк (reorder)

* Разрешено **только** при захвате ячеек **слева до колонки «Auto» включительно**.
* **Запрещено** начинать d\&d на недельных ячейках.
* **Ресурсы** и **задачи** образуют **два не смешиваемых блока**:

   * ресурсы всегда **выше**,
   * перестановка возможна **только** внутри своего блока.

---

### 3.5. Контекстные меню (ПКМ)

**На строке (ресурс/задача)**:

* «Дублировать»
* «Удалить»
* «Добавить выше»
* «Добавить ниже»

**На ячейке `Fn` или `Empl` ресурса**:

* Доп. пункт **«Выбрать цвет»** — color-picker:

   * для `Fn` — сохранить цвет в справочник цветов функций;
   * для `Empl` — сохранить цвет в справочник цветов сотрудников (override).

---

### 3.6. Добавление строк

* Внизу таблицы одна кнопка **«+ Добавить»** → меню:

   * **Ресурс** — вставить новую пустую ресурсную строку **в блок ресурсов**.
   * **Задача** — вставить новую пустую задачу **в блок задач**.

---

### 3.7. Фильтры по колонкам

* В заголовке **каждой не-недельной** колонки — иконка ▾.
* Клик открывает меню фильтра (как в Google Sheets):

   * поле **Поиск** по значениям,
   * **мультивыбор** вариантов,
   * «Сбросить» / «ОК».
* Применение: все активные фильтры объединяются по **AND**.
  Пустой набор в колонке = фильтр не активен.
* Источник значений — **уникальные** значения текущих данных (числа — как строка).

---

### 3.8. Редактирование недельных ячеек

**У задач**:

* **Один клик** по неделе:

   * если было `0` → поставить `if(planEmpl > 0, planEmpl, 1)`,
   * если было `>0` → поставить `0`.
   * Любая ручная правка устанавливает `manualEdited = true` и **отключает** `autoPlanEnabled = false`.
* **Двойной клик** → диалог ввода `float > 0`; по подтверждению записать значение, `manualEdited = true`, `autoPlanEnabled = false`.
* **«Мазок» мышью**: удерживая кнопку после первого клика, провести по соседним неделям — им присваивается **текущее** значение кисти.

**У ресурсов**:

* Прямой ввод числа ≥ 0.
* Фон недельной ячейки:

   * **красный** — перегруз (сумма задач в неделе **>** доступной мощности),
   * **зелёный** — недогруз (сумма задач **<** доступной),
   * прозрачный — равенство.

---

### 3.9. Автоплан (чекбокс `Auto`)

**Включён**:

* Система автоматически размещает задачу непрерывным интервалом длины `planWeeks` **не раньше** `earliestWeek = B(blockers) + 1`.
* Для каждой недели интервала должно выполняться:
  `free(week) = capacity(team, fn, [empl], week) − usedByOtherTasks(team, fn, [empl], week) ≥ planEmpl`.

**Выключен**:

* Если есть ручной план — недельные значения не трогаются.

**Переключение при ручном плане**:

* Если `manualEdited = true` и в неделях задачи есть значения `> 0`, при включении `Auto` показать подтверждение:
  *«Включить автоплан? Текущий ручной план будет перезаписан.»*

   * **ОК**: очистить недельные значения (все `0`), `manualEdited = false`, `autoPlanEnabled = true`, затем выполнить автоплан.
   * **Cancel**: оставить как есть.

**Горячая клавиша**:

* `Space` на выделенной ячейке **Auto** — то же поведение, что клик по чекбоксу (с подтверждением при необходимости).

---

### 3.10. Автополя и пересчёты

* **Fact** = `Σ weeks[i]`.
* **Start** = минимальный `i`, где `weeks[i] > 0`; иначе `null`.
* **End** = максимальный `i`, где `weeks[i] > 0`; иначе `null`.
* **Sprints (auto)** = множество `sprintCode(week)` для всех `week ∈ [Start..End]`, вывод через запятую.

**Триггеры пересчёта**:

* автоплан выполнен;
* ручная правка недель у задачи;
* изменение `planEmpl`, `planWeeks`, `team`, `fn`, `empl`;
* изменение недель у ресурсов (влияет на авторазмещение);
* изменение дат спринтов (влияет на `sprintsAuto`).

---

## 4. Экран «Спринты»

### 4.1. Таблица

| Колонка               | Тип   | Правила                                           |
| --------------------- | ----- | ------------------------------------------------- |
| Код                   | input | Редактируемо.                                     |
| Начало                | date  | Редактируемо.                                     |
| Окончание             | date  | Редактируемо.                                     |
| Недели (предпросмотр) | calc  | Кол-во календарных недель в интервале (readonly). |

### 4.2. Связь с «Планом»

* Заголовки недель используют актуальные спринты.
* `sprintsAuto` у задач пересчитывается после изменения дат.

---

## 5. Зависимости (Blocker)

### 5.1. Функция из Google Sheets

```gs
=IFERROR(
  MAX(
    FILTER(
      'План'!$M:$M;
      ISNUMBER(
        MATCH(
          ROW('План'!$M:$M);
          UNIQUE(FLATTEN(ROW(blockers)));
          0
        )
      )
    )
  );
  0
)
```

**Смысл**: `B(blockers) = max(End week)` по выбранным блокерам; если список пуст — `0`.
`EarliestStart = B + 1` (если `B = 0` → `EarliestStart = 1`).

### 5.2. UI и валидация

* Колонка **Blocker** — **readonly** список чипов с ✖ (удалить).
* **Назначение блокера**:
  **Shift-drag**: зажать `Shift` и нажать на **задаче-источнике** (или в обратной последовательности сначала клик на задаче потом `Shift`) → отпустить на **задаче-блокере**.
* **Запреты**:

   1. Нельзя блокироваться задачей, которая расположена **ниже** текущей в таблице (обратные связи запрещены).
   2. Нельзя образовывать **циклы** в графе зависимостей.
      При нарушении — показать предупреждение и **не** сохранять связь.

---

## 6. Алгоритмы (бизнес-логика)

### 6.1. Вычисление свободной мощности

Для недели `w` и области задачи `(team, fn, [empl?])`:

```
capacity(w)   = Σ ресурсы[team, fn, (empl?)] . weeks[w]
consumption(w)= Σ другие_задачи[team, fn, (empl?)] . weeks[w]
free(w)       = max(0, capacity(w) - consumption(w))
```

### 6.2. Автоплан задачи

```
needLen      = max(0, planWeeks)
needPerWeek  = max(0, planEmpl)
earliest     = B(blockers) + 1   // или 1, если блокеров нет

Найти минимальный start ∈ [earliest .. N - needLen + 1], такой что
  ∀i ∈ [0..needLen-1]: free(start + i) ≥ needPerWeek

Если найден:
  weeks[start..start+needLen-1] = needPerWeek
Иначе:
  weeks[*] = 0  // не ставим задачу (ожидание)
```

### 6.3. Расчёт автополей

```
fact      = Σ weeks[i]
startWeek = min i: weeks[i] > 0   (или null)
endWeek   = max i: weeks[i] > 0   (или null)
sprintsAuto = { mapWeekToSprint(i) | i ∈ [startWeek..endWeek] } // без дублей, в порядке возрастания недель
```

### 6.4. Подсветка ресурса

Для ресурсной строки `R` и недели `w`:

```
cap  = R.weeks[w]
used = Σ задачи[team=R.team, fn=R.fn, match(empl): R.empl ? task.empl=R.empl : true] . weeks[w]

if used > cap  → красный фон (перегруз)
if used < cap  → зелёный фон (недогруз)
else           → прозрачный фон
```

---

## 7. Поведение UI (сводка событий)

### 7.1. Клавиатура

* `←/→` — переместить выделение на соседнюю колонку.
* `Enter` — начать редактировать / сохранить и выйти.
* `Esc` — отменить редактирование.
* `Space` на **Auto** — переключить чекбокс (с подтверждением при ручном плане).

### 7.2. Мышь

* Одинарный клик — выделение ячейки (подсветка).
* Двойной клик — редактирование (если допустимо).
* DnD строки — **только** за ячейки **до «Auto»** включительно; внутри своего блока (ресурсы/задачи).
* **Shift-drag** задача→задача — назначение блокера (с валидациями).
* Таймлайн задач:

   * клик — 0 ↔ `if(planEmpl > 0, planEmpl, 1)`;
   * двойной клик — ввод `float > 0`;
   * «мазок» — растягивание текущего значения по неделям.

### 7.3. Контекстное меню

* На строке: «Дублировать» / «Удалить» / «Добавить выше» / «Добавить ниже».
* На `Fn`/`Empl` ресурса: «выбрать цвет» (color-picker).

---

## 8. Добавление/удаление/дублирование

* **Дублировать**: создать копию строки под оригиналом.
  Для задачи — копировать поля и `blockerIds` (без изменения ссылок); недельные значения можно копировать как есть.
* **Удалить**: убрать строку; при удалении задачи в других задачах удалить из `blockerIds` ссылку на неё.
* **Добавить выше/ниже**: вставить новую строку **того же типа** рядом.
* **+ Добавить** снизу: «Ресурс» → в блок ресурсов; «Задача» → в блок задач.

---

## 9. Валидации и ограничения

* `planEmpl ≥ 0`, `planWeeks ≥ 0` (целое), недельные значения `float ≥ 0`.
* Колонка **Sprints (auto)** — нередактируемая.
* Колонка **Blocker** — редактируется **только** через Shift-drag (добавить) и ✖ (удалить).
* Блокер-цель **не может** быть ниже источника.
* Запрещены **циклические** зависимости.
* Включение `Auto` при ручном плане — **только** после подтверждения.

---

## 10. Цвета

* Цвет задачи: `color(empl) > color(fn) > default`.
* Назначение цвета `fn`/`empl` — через ПКМ на соответствующей ячейке в ресурсной строке.
* Изменение цвета применяется к **всем** уже отрисованным блокам задач.

---

## 11. Нефункциональные требования (уровень UX/данных)

* Все операции — максимально инлайн; подтверждения — краткие.
* Количество недель `N` — параметризуемое (логика не зависит от фиксированного числа).
* Выделение и фокус всегда **видимы**.
* Все пересчёты выполняются **немедленно** при соответствующих действиях (§3.10).

---

## 13. Псевдокод ключевых функций (для AI-агента)

**Поиск спринта недели**

```pseudo
function mapWeekToSprint(weekIndex0):
  date = week0 + weekIndex0 * 7 days
  for s in sprints:
    if s.start <= date <= s.end: return s.code
  return null
```

**Свободная мощность**

```pseudo
free(week, team, fn, empl?):
  cap  = sum(res.weeks[week] for res in resources where res.team=team and res.fn=fn and (empl? -> res.empl=empl))
  used = sum(t.weeks[week]   for t in tasks     where t.team=team and t.fn=fn and (empl? -> t.empl=empl))
  return max(0, cap - used)
```

**B и EarliestStart**

```pseudo
B(task):
  if task.blockerIds is empty: return 0
  return max( endWeek(b) for b in blockers ) or 0

EarliestStart = B(task) + 1 (or 1 if B=0)
```

**Автоплан**

```pseudo
autoPlace(task):
  needLen = max(0, task.planWeeks)
  needP   = max(0, task.planEmpl)
  start0  = max(1, EarliestStart(task))

  for start in [start0 .. N - needLen + 1]:
    ok = true
    for offset in [0 .. needLen-1]:
      if free(start+offset-1, task.team, task.fn, task.empl?) < needP:
        ok = false; break
    if ok:
      // Заполнить
      weeks = [0]*N
      for i in [0 .. needLen-1]: weeks[start+i-1] = needP
      return weeks

  return [0]*N  // места нет
```

**Перерасчёт автополей**

```pseudo
recalc(task):
  fact = sum(task.weeks)
  nz   = [i for i in 1..N if task.weeks[i-1] > 0]
  startWeek = min(nz) or null
  endWeek   = max(nz) or null
  sprintsAuto = uniq([ mapWeekToSprint(i-1) for i in [startWeek..endWeek] if mapWeekToSprint(i-1) != null ])
```

**Валидация блокера**

```pseudo
canSetBlocker(srcId, blockerId):
  // 1) запрет блокера ниже по таблице
  if index(blockerId) > index(srcId): return false

  // 2) запрет циклов
  graph = { t.id -> t.blockerIds }
  graph[srcId] = graph[srcId] + [blockerId]
  return not existsPath(blockerId -> srcId, graph)
```
